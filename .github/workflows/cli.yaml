name: "@coat/cli"
on: push

jobs:
  build:
    name: Lint, Test & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          npm ci
          npx --no-install lerna bootstrap
      - name: Lint
        run: npx --no-install lerna run lint --stream
      - name: Test
        run: |
          npx --no-install lerna run test --stream -- -- \
          --ci \
          --no-cache \
          --runInBand \
          --coverageReporters json \
          --coverageReporters lcov \
          --coverageReporters text \
          --coverageReporters clover
      - name: Upload test coverage information
        run: bash <(curl -s https://codecov.io/bash)
      - name: Build cli
        # The pack command does currently not allow to specify an output filename,
        # however, it does print out the name of the file as the last line.
        #
        # In order to always generate the same "coat-cli.tgz" file,
        # the output file is renamed after npm pack finishes.
        #
        # The transpilation and type definition generation are run
        # automatically with the "prepack" script
        run: mv "$(npm pack | tail -n 1)" coat-cli.tgz
        working-directory: ./packages/cli
      - uses: actions/upload-artifact@v2
        with:
          name: coat-cli
          path: packages/cli/coat-cli.tgz
      - name: Build template-ts-package
        # The pack command does currently not allow to specify an output filename,
        # however, it does print out the name of the file as the last line.
        #
        # In order to always generate the same "coat-template-ts-package.tgz" file,
        # the output file is renamed after npm pack finishes.
        #
        # The transpilation and type definition generation are run
        # automatically with the "prepare" script
        run: mv "$(npm pack | tail -n 1)" coat-template-ts-package.tgz
        working-directory: ./packages/template-ts-package
      - uses: actions/upload-artifact@v2
        with:
          name: coat-cli
          path: packages/cli/coat-template-ts-package.tgz
  integration-tests:
    name: Integration tests
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [10, 12, 14]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node }}
      - name: Install dependencies
        run: |
          npm ci
          npx --no-install lerna bootstrap
      - name: Decrease npm retry factors on macOS
        if: matrix.os == 'macos-latest'
        run: |
          echo "::set-env name=npm_config_fetch_retries::50"
          echo "::set-env name=npm_config_fetch_retry_factor::2"
          echo "::set-env name=npm_config_fetch_retry_mintimeout::50"
          echo "::set-env name=npm_config_fetch_retry_maxtimeout::6000"
      - name: Run all tests
        run: npm run test:all -- --ci --no-cache --runInBand
        working-directory: ./packages/cli
